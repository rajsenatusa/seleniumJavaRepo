package testCases;

import java.io.File;
import java.io.FileOutputStream;
import java.time.Duration;

import org.apache.poi.ss.usermodel.Row;
import org.apache.poi.ss.usermodel.Workbook;
import org.apache.poi.ss.usermodel.WorkbookFactory;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.WebDriverWait;
import org.testng.Assert;
import org.testng.SkipException;
import org.testng.annotations.Test;

import Utilities.DataProviders;
import Utilities.ExcelUtility;
import pageObjects.InClaimsMaintenancePage;
import pageObjects.InHomePage;
import testBase.testBaseClass;

public class TC03_CopyProviderCode extends testBaseClass {
	

    @Test(dataProvider = "providerData", dataProviderClass = DataProviders.class, groups = {"datadriven"})
    public void verify_copy_provider(String username, String password, String firstname, String lastname, String phonenumber,
                                     String licencenumber, String licensexp, String emailaddress, String manager, String roleofuser) {

        logger.info(" **Copy Provider Code Test Started! **");      
        
        try {
            // Logging input data for visibility
            logger.info("User Data: " + String.format("Username: %s, Password: %s, FirstName: %s, LastName: %s", username, password, firstname, lastname));

            // Check for null data in provider fields
            if (username == null || password == null || firstname == null || lastname == null ||
                phonenumber == null || licencenumber == null || licensexp == null ||
                emailaddress == null || manager == null || roleofuser == null) {

                logger.error("Missing required data. Skipping test.");
                throw new SkipException("Skipping test due to missing required data.");
            }

            // Home Page - Log in
            InHomePage hp = new InHomePage(driver);
            logger.info("Entering login credentials for user: " + username);
            hp.setUsername(username);
            hp.setPassword(password);
            hp.clickSignIn();

            // Navigate to Claims Maintenance Page
            logger.info("Navigating to Claims Maintenance page...");
            InClaimsMaintenancePage cmp = new InClaimsMaintenancePage(driver);
            cmp.clickClaimsMenu();
            cmp.clickClaimMaintenance();
            cmp.clickProvider();

            // Search for Provider and Copy
            cmp.selectSearchbyList();
            cmp.setSearchText("CA0TYNA");
            cmp.clickSearchBtn();

            // Explicit wait for provider list to appear
            
            WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(50));
            wait.until(ExpectedConditions.elementToBeClickable(cmp.getProviderListElement()));            
            cmp.clickProviderListText();
            cmp.clickCopyBtn();
            
            // Wait for the page to load after clicking copy
            wait.until(ExpectedConditions.visibilityOf(cmp.getProviderFormElement()));
            
            String fullName = String.join(" ", firstname, lastname);
            logger.info("Filling provider information for: " + fullName);

            cmp.setBusinessName(fullName);
            cmp.setName(fullName);
            cmp.setDBAName(fullName);
            cmp.setProviderPrimaryPhoneNumber(phonenumber);
            cmp.setProviderFaxNumber(phonenumber);
            cmp.setProviderEmailAddress(emailaddress);
            cmp.setProviderAccounBusinessName(fullName);
            cmp.setProviderAccounBusinessName2(fullName);

            // Generate provider number
  
            String ProviderCode = generateProviderNumber("CA0", 4);
            logger.info("Generated Provider Code: " + ProviderCode);
            cmp.setProviderNumber(ProviderCode);
            cmp.clickSaveBtn();
            
          	
            // Wait for save confirmation
            wait.until(ExpectedConditions.textToBePresentInElement(cmp.getSaveConfirmationElement(), ProviderCode));

            // Validate that the correct provider code was saved
            String capturedProviderCode = cmp.getProviderCode();
            Assert.assertEquals(capturedProviderCode, ProviderCode, "Provider Code mismatch after saving.");
            logger.info("Provider code successfully added and verified: " + capturedProviderCode);         
            
            // Log out
            cmp.SignOutInsuranceNow();
            logger.info("Provider code test completed successfully and user signed out.");  
            
          
            // Write the generated provider code to the Excel sheet

         
            
    		String excelPath = "C:\\Users\\SRajendran\\InsuranceNow_v1.0\\InsuranceNow_v1.0\\testData\\providerData_Results.xlsx"; // Specify your Excel file path to write provider code
    		ExcelUtility excelUtils = new ExcelUtility(excelPath);
    		//int providerCodeColumn = 10; 
            
            excelUtils.writeResultsToExcel( username,  password,  firstname,  lastname,  phonenumber,
                     licencenumber,  licensexp,  emailaddress,  manager,  roleofuser, capturedProviderCode);
    		
    		
//    		int rowNum = excelUtils.getNextEmptyCellInColumn("Sheet1", 11); // Get next available row
//            excelUtils.writeCellData("Sheet1", rowNum, providerCodeColumn, capturedProviderCode);
            logger.info("Written provider code to Excel: " + capturedProviderCode);

                    
        } catch (SkipException e) {
            logger.warn("Test Skipped: " + e.getMessage());
            throw e;  // Re-throw to ensure it's logged as skipped in reports

        } catch (Exception e) {
            logger.error("Exception occurred: " + e.getMessage(), e);
            Assert.fail("Test failed due to an exception: " + e.getMessage());

        } finally {
            logger.info(" **Add New Provider Number Test Completed! **");
        }
    }


}
